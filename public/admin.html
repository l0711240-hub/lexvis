<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LexVis ê´€ë¦¬ì</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0e0f14;--surface:#161820;--surface2:#1e2028;--border:#2a2d3a;--text:#dde2f0;--text-muted:#7b82a0;--text-dim:#4a5070;--accent:#c8a96e;--accent-dim:rgba(200,169,110,.15);--blue:#5b8dee;--blue-dim:rgba(91,141,238,.15);--green:#5cc878;--green-dim:rgba(92,200,120,.15);--red:#e05c5c;--red-dim:rgba(224,92,92,.15);--purple:#a07de0;--font:'Noto Sans KR',sans-serif;--mono:'JetBrains Mono',monospace;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.6;}
/* ë ˆì´ì•„ì›ƒ */
.layout{display:grid;grid-template-columns:200px 1fr;min-height:100vh;}
/* ì‚¬ì´ë“œë°” */
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:0;position:sticky;top:0;height:100vh;}
.sidebar-logo{padding:20px 18px;font-size:16px;font-weight:600;color:var(--accent);border-bottom:1px solid var(--border);}
.sidebar-logo span{color:var(--text-muted);font-weight:400;font-size:12px;display:block;margin-top:2px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:11px 18px;color:var(--text-muted);cursor:pointer;font-size:13px;border-left:2px solid transparent;transition:all .15s;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{border-left-color:var(--accent);color:var(--accent);background:rgba(200,169,110,.06);}
.nav-icon{font-size:14px;width:16px;text-align:center;}
.nav-section{padding:14px 18px 6px;font-size:10px;font-family:var(--mono);color:var(--text-dim);letter-spacing:.1em;text-transform:uppercase;}
.nav-divider{height:1px;background:var(--border);margin:8px 0;}
.sidebar-bottom{position:absolute;bottom:0;left:0;right:0;padding:14px 18px;border-top:1px solid var(--border);}
.api-status{display:flex;align-items:center;gap:7px;font-size:11px;font-family:var(--mono);}
.dot{width:7px;height:7px;border-radius:50%;}
.dot.ok{background:var(--green);box-shadow:0 0 6px var(--green);}
.dot.off{background:var(--red);box-shadow:0 0 6px var(--red);}
/* ë©”ì¸ */
.main{padding:28px 36px;overflow-y:auto;}
.page-section{display:none;}.page-section.active{display:block;}
/* í—¤ë” */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
.page-title{font-size:20px;font-weight:600;}
.page-sub{font-size:12px;color:var(--text-muted);margin-top:3px;}
/* ì¹´ë“œ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:16px;}
.card-title{font-size:13px;font-weight:600;margin-bottom:14px;color:var(--accent);display:flex;align-items:center;gap:8px;}
/* í¼ */
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.form-grid.col3{grid-template-columns:1fr 1fr 1fr;}
.form-grid.col1{grid-template-columns:1fr;}
.field{display:flex;flex-direction:column;gap:4px;}
.field label{font-size:11px;color:var(--text-muted);font-family:var(--mono);}
.field input,.field textarea,.field select{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:8px 10px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;transition:border-color .15s;width:100%;}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--accent);}
.field textarea{resize:vertical;min-height:72px;line-height:1.7;}
.field textarea.tall{min-height:160px;}
.span2{grid-column:1/-1;}
/* ë²„íŠ¼ */
.btn{padding:8px 18px;border:none;border-radius:4px;font-size:13px;font-weight:500;cursor:pointer;font-family:var(--font);transition:all .15s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:#0e0f14;}
.btn-primary:hover{opacity:.88;}
.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid var(--red);}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-ghost{background:transparent;color:var(--text-muted);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
.btn-sm{padding:5px 11px;font-size:12px;}
.btn-group{display:flex;gap:8px;margin-top:14px;}
/* í…Œì´ë¸”/ë¦¬ìŠ¤íŠ¸ */
.data-table{width:100%;border-collapse:collapse;}
.data-table th{text-align:left;padding:8px 12px;font-size:11px;font-family:var(--mono);color:var(--text-dim);letter-spacing:.06em;border-bottom:1px solid var(--border);}
.data-table td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
.data-table tr:hover td{background:var(--surface2);}
.data-table tr:last-child td{border-bottom:none;}
.badge{display:inline-flex;padding:2px 8px;border-radius:10px;font-size:10px;font-family:var(--mono);}
.badge-case{background:var(--accent-dim);color:var(--accent);}
.badge-law{background:var(--blue-dim);color:var(--blue);}
.badge-local{background:var(--green-dim);color:var(--green);}
.empty{text-align:center;padding:32px;color:var(--text-dim);font-size:13px;}
/* íƒ­ */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px;}
.tab{padding:9px 18px;font-size:13px;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
/* í† ìŠ¤íŠ¸ */
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--accent);color:var(--text);padding:10px 18px;border-radius:6px;font-size:13px;z-index:9999;animation:toastIn .25s ease;}
@keyframes toastIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
/* ìƒíƒœ ë°°ì§€ */
.status-ok{color:var(--green);font-size:11px;font-family:var(--mono);}
.status-off{color:var(--red);font-size:11px;font-family:var(--mono);}
/* ì„¹ì…˜ êµ¬ë¶„ì„  */
.section-sep{height:1px;background:var(--border);margin:20px 0;}
/* ê´€ë ¨íŒë¡€ ì…ë ¥ */
.related-item{display:flex;gap:8px;margin-bottom:7px;align-items:flex-start;}
.related-item input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:7px 9px;color:var(--text);font-size:12px;outline:none;}
.related-item input:focus{border-color:var(--accent);}
.remove-btn{background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);cursor:pointer;padding:6px 9px;font-size:12px;flex-shrink:0;}
.remove-btn:hover{border-color:var(--red);color:var(--red);}
.add-related-btn{background:none;border:1px dashed var(--border);border-radius:4px;color:var(--text-dim);cursor:pointer;padding:6px 14px;font-size:12px;width:100%;transition:all .15s;}
.add-related-btn:hover{border-color:var(--accent);color:var(--accent);}
/* ì¡°ë¬¸ ì…ë ¥ */
.article-block{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:10px;}
.article-block-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.article-num{font-family:var(--mono);font-size:12px;color:var(--accent);}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>
<div class="layout">
  <!-- ì‚¬ì´ë“œë°” -->
  <aside class="sidebar">
    <div class="sidebar-logo">LexVis ê´€ë¦¬ì<span>ë°ì´í„° ì§ì ‘ í¸ì§‘</span></div>
    <div class="nav-section">ë°ì´í„° ê´€ë¦¬</div>
    <div class="nav-item active" onclick="showPage('cases')"><span class="nav-icon">âš–</span>íŒë¡€ ê´€ë¦¬</div>
    <div class="nav-item" onclick="showPage('laws')"><span class="nav-icon">ğŸ“„</span>ë²•ë¥  ê´€ë¦¬</div>
    <div class="nav-item" onclick="showPage('terms')"><span class="nav-icon">âŠ</span>ìš©ì–´ ì‚¬ì „</div>
    <div class="nav-divider"></div>
    <div class="nav-section">ë°”ë¡œê°€ê¸°</div>
    <div class="nav-item" onclick="window.open('/', '_blank')"><span class="nav-icon">â†—</span>ì‚¬ì´íŠ¸ ì—´ê¸°</div>
    <div class="sidebar-bottom">
      <div class="api-status">
        <div class="dot" id="apiDot"></div>
        <span id="apiStatusText">API í™•ì¸ì¤‘...</span>
      </div>
    </div>
  </aside>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="main">

    <!-- â•â• íŒë¡€ ê´€ë¦¬ â•â• -->
    <div class="page-section active" id="page-cases">
      <div class="page-header">
        <div><div class="page-title">íŒë¡€ ê´€ë¦¬</div><div class="page-sub">íŒë¡€ë¥¼ ì¶”ê°€, ìˆ˜ì •, ì‚­ì œí•©ë‹ˆë‹¤. cases.jsonì— ì €ì¥ë©ë‹ˆë‹¤.</div></div>
        <button class="btn btn-primary" onclick="showCaseForm()">+ ìƒˆ íŒë¡€ ì¶”ê°€</button>
      </div>

      <!-- ì¶”ê°€/ìˆ˜ì • í¼ -->
      <div class="card" id="caseFormCard" style="display:none;">
        <div class="card-title" id="caseFormTitle">âŠ• ìƒˆ íŒë¡€ ì¶”ê°€</div>
        <input type="hidden" id="caseEditId">
        <div class="form-grid col3">
          <div class="field"><label>ì‚¬ê±´ë²ˆí˜¸ *</label><input id="fCaseNum" placeholder="ì˜ˆ: 2023ë„14521"></div>
          <div class="field"><label>ë²•ì› *</label>
            <select id="fCaseCourt">
              <option>ëŒ€ë²•ì›</option><option>í—Œë²•ì¬íŒì†Œ</option><option>ì„œìš¸ê³ ë²•</option>
              <option>ì„œìš¸ì¤‘ì•™ì§€ë²•</option><option>ë¶€ì‚°ê³ ë²•</option><option>ê¸°íƒ€</option>
            </select>
          </div>
          <div class="field"><label>ì„ ê³ ì¼ (YYYYMMDD)</label><input id="fCaseDate" placeholder="ì˜ˆ: 20240314"></div>
        </div>
        <div class="form-grid">
          <div class="field"><label>ì‚¬ê±´ëª… *</label><input id="fCaseName" placeholder="ì˜ˆ: ì—…ë¬´ìƒê³¼ì‹¤ì¹˜ì‚¬ â€” ì˜ë£Œê³¼ì‹¤ ì„±ë¦½ ìš”ê±´"></div>
          <div class="field"><label>ê²°ê³¼</label>
            <select id="fCaseResult">
              <option>íŒŒê¸°í™˜ì†¡</option><option>ìƒê³ ê¸°ê°</option><option>ê¸°ê°</option>
              <option>ì¸ìš©</option><option>í•©í—Œ</option><option>ìœ„í—Œ</option><option>í•­ì†Œê¸°ê°</option>
            </select>
          </div>
        </div>
        <div class="form-grid">
          <div class="field"><label>ë¶„ì•¼</label>
            <select id="fCaseCat">
              <option>í˜•ë²•</option><option>ë¯¼ë²•</option><option>í—Œë²•</option>
              <option>ìƒë²•</option><option>í–‰ì •ë²•</option><option>ë…¸ë™ë²•</option><option>ì˜ë£Œë²•</option>
            </select>
          </div>
          <div class="field"><label>ì°¸ì¡°ì¡°ë¬¸ (ì‰¼í‘œ êµ¬ë¶„)</label><input id="fCaseRefLaws" placeholder="ì˜ˆ: í˜•ë²• ì œ268ì¡°, ì˜ë£Œë²• ì œ21ì¡°"></div>
        </div>
        <div class="form-grid col1">
          <div class="field"><label>íŒì‹œì‚¬í•­</label><textarea id="fCaseSummary" placeholder="ì´ ì‚¬ê±´ì˜ ì£¼ìš” ë²•ì  ìŸì ì„ ìš”ì•½ ì…ë ¥..."></textarea></div>
          <div class="field"><label>íŒê²°ìš”ì§€</label><textarea id="fCaseGist" placeholder="íŒê²°ì˜ í•µì‹¬ ë‚´ìš© ìš”ì•½..."></textarea></div>
          <div class="field"><label>íŒë¡€ ì „ë¬¸ *</label><textarea id="fCaseFullText" class="tall" placeholder="íŒë¡€ ë³¸ë¬¸ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea></div>
        </div>

        <div class="section-sep"></div>
        <div class="card-title" style="font-size:12px;">â–² ìƒê¸‰ì‹¬ / ì„ í–‰ íŒë¡€</div>
        <div id="upperRelated"></div>
        <button class="add-related-btn" onclick="addRelatedRow('upper')">+ ìƒê¸‰ì‹¬ íŒë¡€ ì¶”ê°€</button>

        <div style="margin-top:12px;"></div>
        <div class="card-title" style="font-size:12px;">â–¼ í•˜ê¸‰ì‹¬ / í›„ì† íŒë¡€</div>
        <div id="lowerRelated"></div>
        <button class="add-related-btn" onclick="addRelatedRow('lower')">+ í•˜ê¸‰ì‹¬ íŒë¡€ ì¶”ê°€</button>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="submitCase()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-ghost" onclick="hideCaseForm()">ì·¨ì†Œ</button>
        </div>
      </div>

      <!-- íŒë¡€ ëª©ë¡ -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div class="card-title" style="margin:0;">ë“±ë¡ëœ íŒë¡€ <span id="casesCount" style="color:var(--text-dim);font-size:12px;"></span></div>
          <input id="caseSearchInput" placeholder="ê²€ìƒ‰..." style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--text);font-size:12px;outline:none;width:200px;" oninput="filterCases()">
        </div>
        <table class="data-table">
          <thead><tr><th>ì‚¬ê±´ë²ˆí˜¸</th><th>ì‚¬ê±´ëª…</th><th>ë²•ì›</th><th>ì„ ê³ ì¼</th><th>ê²°ê³¼</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="caseTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• ë²•ë¥  ê´€ë¦¬ â•â• -->
    <div class="page-section" id="page-laws">
      <div class="page-header">
        <div><div class="page-title">ë²•ë¥  ê´€ë¦¬</div><div class="page-sub">ë²•ë ¹ì„ ì¶”ê°€, ìˆ˜ì •, ì‚­ì œí•©ë‹ˆë‹¤. laws.jsonì— ì €ì¥ë©ë‹ˆë‹¤.</div></div>
        <button class="btn btn-primary" onclick="showLawForm()">+ ìƒˆ ë²•ë ¹ ì¶”ê°€</button>
      </div>

      <div class="card" id="lawFormCard" style="display:none;">
        <div class="card-title" id="lawFormTitle">âŠ• ìƒˆ ë²•ë ¹ ì¶”ê°€</div>
        <input type="hidden" id="lawEditMst">
        <div class="form-grid col3">
          <div class="field"><label>ë²•ë ¹ëª… *</label><input id="fLawName" placeholder="ì˜ˆ: í˜•ë²•"></div>
          <div class="field"><label>ì¢…ë¥˜</label>
            <select id="fLawType"><option>ë²•ë¥ </option><option>í—Œë²•</option><option>ëŒ€í†µë ¹ë ¹</option><option>ë¶€ë ¹</option></select>
          </div>
          <div class="field"><label>ì†Œê´€ë¶€ì²˜</label><input id="fLawDept" placeholder="ì˜ˆ: ë²•ë¬´ë¶€"></div>
        </div>
        <div class="form-grid">
          <div class="field"><label>ê³µí¬ì¼ (YYYYMMDD)</label><input id="fLawPromulg" placeholder="ì˜ˆ: 19530918"></div>
          <div class="field"><label>ì‹œí–‰ì¼ (YYYYMMDD)</label><input id="fLawEnforce" placeholder="ì˜ˆ: 19530918"></div>
        </div>

        <div class="section-sep"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div class="card-title" style="margin:0;font-size:12px;">ì¡°ë¬¸ ëª©ë¡</div>
          <button class="btn btn-ghost btn-sm" onclick="addArticleBlock()">+ ì¡°ë¬¸ ì¶”ê°€</button>
        </div>
        <div id="articleBlocks"></div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="submitLaw()">ğŸ’¾ ì €ì¥</button>
          <button class="btn btn-ghost" onclick="hideLawForm()">ì·¨ì†Œ</button>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div class="card-title" style="margin:0;">ë“±ë¡ëœ ë²•ë ¹ <span id="lawsCount" style="color:var(--text-dim);font-size:12px;"></span></div>
        </div>
        <table class="data-table">
          <thead><tr><th>ë²•ë ¹ëª…</th><th>ì¢…ë¥˜</th><th>ì†Œê´€ë¶€ì²˜</th><th>ì‹œí–‰ì¼</th><th>ì¡°ë¬¸ìˆ˜</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="lawTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- â•â• ìš©ì–´ ì‚¬ì „ â•â• -->
    <div class="page-section" id="page-terms">
      <div class="page-header">
        <div><div class="page-title">ìš©ì–´ ì‚¬ì „</div><div class="page-sub">ë²•ë¥  ìš©ì–´ë¥¼ ì¶”ê°€, ìˆ˜ì •, ì‚­ì œí•©ë‹ˆë‹¤. terms.jsonì— ì €ì¥ë©ë‹ˆë‹¤.</div></div>
      </div>
      <div class="card">
        <div class="card-title">ìƒˆ ìš©ì–´ ì¶”ê°€</div>
        <div class="form-grid col3">
          <div class="field"><label>ìš©ì–´ *</label><input id="fTermWord" placeholder="ì˜ˆ: ë¬´ì£„ì¶”ì •"></div>
          <div class="field"><label>í•œì/ì˜ë¬¸</label><input id="fTermHanja" placeholder="ì˜ˆ: ç„¡ç½ªæ¨å®š"></div>
          <div class="field"><label>ê´€ë ¨ ë²•ë ¹</label><input id="fTermLaw" placeholder="ì˜ˆ: í—Œë²• ì œ27ì¡° ì œ4í•­"></div>
        </div>
        <div class="form-grid col1">
          <div class="field"><label>ì •ì˜ *</label><textarea id="fTermDef" placeholder="ìš©ì–´ì— ëŒ€í•œ ë²•ì  ì •ì˜ì™€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="submitTerm()">+ ì¶”ê°€</button>
          <button class="btn btn-ghost" onclick="clearTermForm()">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div class="card-title" style="margin:0;">ë“±ë¡ëœ ìš©ì–´ <span id="termsCount" style="color:var(--text-dim);font-size:12px;"></span></div>
          <input id="termSearchInput" placeholder="ê²€ìƒ‰..." style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--text);font-size:12px;outline:none;width:200px;" oninput="filterTerms()">
        </div>
        <table class="data-table">
          <thead><tr><th>ìš©ì–´</th><th>í•œì</th><th>ì •ì˜ (ìš”ì•½)</th><th>ê´€ë ¨ ë²•ë ¹</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody id="termTableBody"></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê³µí†µ ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event.currentTarget.classList.add('active');
  if (name === 'cases') loadCases();
  if (name === 'laws')  loadLaws();
  if (name === 'terms') loadTerms();
}

function toast(msg, color='var(--accent)') {
  const t = document.createElement('div');
  t.className = 'toast';
  t.style.borderColor = color;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2800);
}

function formatDate(d) {
  if (!d) return '-';
  const s = String(d);
  if (s.length === 8) return `${s.slice(0,4)}.${s.slice(4,6)}.${s.slice(6,8)}`;
  return s;
}

async function apiFetch(url, opts={}) {
  const res = await fetch(url, opts);
  if (!res.ok) { const e = await res.json().catch(()=>({error:res.statusText})); throw new Error(e.error); }
  return res.json();
}

// API ìƒíƒœ í™•ì¸
async function checkApiStatus() {
  try {
    const r = await fetch('/api/precedent/search?query=test&display=1');
    const d = await r.json();
    const hasApi = d.items?.some(i => i.source === 'api');
    document.getElementById('apiDot').className = 'dot ' + (hasApi ? 'ok' : 'off');
    document.getElementById('apiStatusText').textContent = hasApi ? 'API ì—°ê²°ë¨' : 'ë¡œì»¬ ëª¨ë“œ';
  } catch { document.getElementById('apiDot').className = 'dot off'; document.getElementById('apiStatusText').textContent = 'ì„œë²„ ì˜¤ë¥˜'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íŒë¡€ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allCases = [];

async function loadCases() {
  try {
    const data = await apiFetch('/api/precedent/search?query=');
    allCases = data.items || [];
    renderCaseTable(allCases);
    document.getElementById('casesCount').textContent = `(${allCases.length}ê°œ)`;
  } catch(e) { toast('íŒë¡€ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

function renderCaseTable(cases) {
  const tbody = document.getElementById('caseTableBody');
  if (!cases.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty">ë“±ë¡ëœ íŒë¡€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
  tbody.innerHTML = cases.map(c => `
    <tr>
      <td><span style="font-family:var(--mono);font-size:12px;">${c.caseNum||'-'}</span></td>
      <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${c.caseName||'-'}</td>
      <td>${c.court||'-'}</td>
      <td style="font-family:var(--mono);font-size:11px;">${formatDate(c.date)}</td>
      <td><span class="badge badge-case">${c.result||'-'}</span></td>
      <td>
        ${c.source==='local' ? `<button class="btn btn-ghost btn-sm" onclick="editCase('${c.id}')">ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCase('${c.id}')">ì‚­ì œ</button>` : '<span style="color:var(--text-dim);font-size:11px;">API ë°ì´í„°</span>'}
      </td>
    </tr>`).join('');
}

function filterCases() {
  const q = document.getElementById('caseSearchInput').value.toLowerCase();
  renderCaseTable(allCases.filter(c =>
    c.caseNum?.toLowerCase().includes(q) || c.caseName?.toLowerCase().includes(q) || c.court?.includes(q)
  ));
}

function showCaseForm(prefill={}) {
  document.getElementById('caseFormCard').style.display = 'block';
  document.getElementById('caseFormCard').scrollIntoView({ behavior:'smooth' });
  document.getElementById('caseFormTitle').textContent = 'âŠ• ìƒˆ íŒë¡€ ì¶”ê°€';
  document.getElementById('caseEditId').value = '';
  // í¼ ì´ˆê¸°í™”
  ['fCaseNum','fCaseName','fCaseDate','fCaseRefLaws','fCaseSummary','fCaseGist','fCaseFullText'].forEach(id => {
    document.getElementById(id).value = prefill[id] || '';
  });
  if (prefill.fCaseCourt) document.getElementById('fCaseCourt').value = prefill.fCaseCourt;
  if (prefill.fCaseResult) document.getElementById('fCaseResult').value = prefill.fCaseResult;
  if (prefill.fCaseCat) document.getElementById('fCaseCat').value = prefill.fCaseCat;
  document.getElementById('upperRelated').innerHTML = '';
  document.getElementById('lowerRelated').innerHTML = '';
  (prefill.upperRelated||[]).forEach(r => addRelatedRow('upper', r));
  (prefill.lowerRelated||[]).forEach(r => addRelatedRow('lower', r));
}

function hideCaseForm() { document.getElementById('caseFormCard').style.display = 'none'; }

function editCase(id) {
  const c = allCases.find(x => x.id === id);
  if (!c) return;
  showCaseForm({
    fCaseNum: c.caseNum, fCaseName: c.caseName, fCaseCourt: c.court,
    fCaseDate: c.date, fCaseResult: c.result, fCaseCat: c.category,
    fCaseRefLaws: c.refLaws, fCaseSummary: c.summary, fCaseGist: c.gist,
    fCaseFullText: c.fullText, upperRelated: c.relatedUpper, lowerRelated: c.relatedLower,
  });
  document.getElementById('caseEditId').value = id;
  document.getElementById('caseFormTitle').textContent = 'âœ íŒë¡€ ìˆ˜ì •';
}

async function deleteCase(id) {
  if (!confirm('ì´ íŒë¡€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await apiFetch(`/api/precedent/local/${id}`, { method:'DELETE' });
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); loadCases();
  } catch(e) { toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

function addRelatedRow(side, data={}) {
  const container = document.getElementById(side === 'upper' ? 'upperRelated' : 'lowerRelated');
  const div = document.createElement('div');
  div.className = 'related-item';
  div.innerHTML = `
    <input placeholder="ì‚¬ê±´ë²ˆí˜¸ (ì˜ˆ: 2018ë„16002)" value="${data.caseNum||''}">
    <input placeholder="ì‚¬ê±´ëª…" value="${data.caseName||''}">
    <input placeholder="ë²•ì›" style="max-width:110px;" value="${data.court||''}">
    <input placeholder="ì„ ê³ ì¼ (YYYYMMDD)" style="max-width:130px;" value="${data.date||''}">
    <button class="remove-btn" onclick="this.parentElement.remove()">âœ•</button>`;
  container.appendChild(div);
}

function getRelatedRows(side) {
  const container = document.getElementById(side === 'upper' ? 'upperRelated' : 'lowerRelated');
  return Array.from(container.querySelectorAll('.related-item')).map(row => {
    const inputs = row.querySelectorAll('input');
    return { caseNum: inputs[0].value, caseName: inputs[1].value, court: inputs[2].value, date: inputs[3].value };
  }).filter(r => r.caseNum.trim());
}

async function submitCase() {
  const caseNum  = document.getElementById('fCaseNum').value.trim();
  const caseName = document.getElementById('fCaseName').value.trim();
  const fullText = document.getElementById('fCaseFullText').value.trim();
  if (!caseNum || !caseName) { toast('ì‚¬ê±´ë²ˆí˜¸ì™€ ì‚¬ê±´ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'var(--red)'); return; }

  const payload = {
    caseNum, caseName,
    court:    document.getElementById('fCaseCourt').value,
    date:     document.getElementById('fCaseDate').value.trim(),
    result:   document.getElementById('fCaseResult').value,
    category: document.getElementById('fCaseCat').value,
    refLaws:  document.getElementById('fCaseRefLaws').value.trim(),
    summary:  document.getElementById('fCaseSummary').value.trim(),
    gist:     document.getElementById('fCaseGist').value.trim(),
    fullText,
    relatedUpper: getRelatedRows('upper'),
    relatedLower: getRelatedRows('lower'),
  };

  const editId = document.getElementById('caseEditId').value;
  try {
    if (editId) {
      // ìˆ˜ì •: ì‚­ì œ í›„ ì¬ì¶”ê°€
      await apiFetch(`/api/precedent/local/${editId}`, { method:'DELETE' });
    }
    await apiFetch('/api/precedent/local', {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    toast(editId ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'íŒë¡€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    hideCaseForm(); loadCases();
  } catch(e) { toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë²•ë¥  ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allLaws = [];

async function loadLaws() {
  try {
    const data = await apiFetch('/api/law/search?query=');
    allLaws = data.items || [];
    renderLawTable(allLaws);
    document.getElementById('lawsCount').textContent = `(${allLaws.length}ê°œ)`;
  } catch(e) { toast('ë²•ë ¹ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

function renderLawTable(laws) {
  const tbody = document.getElementById('lawTableBody');
  if (!laws.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty">ë“±ë¡ëœ ë²•ë ¹ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
  tbody.innerHTML = laws.map(l => `
    <tr>
      <td style="font-weight:500;">${l.name||'-'}</td>
      <td><span class="badge badge-law">${l.type||'ë²•ë¥ '}</span></td>
      <td>${l.department||'-'}</td>
      <td style="font-family:var(--mono);font-size:11px;">${formatDate(l.enforcDate)}</td>
      <td style="font-family:var(--mono);font-size:11px;">${(l.articles||[]).length}ê°œ</td>
      <td>
        ${l.source==='local' ? `<button class="btn btn-ghost btn-sm" onclick="editLaw('${l.mst}')">ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="deleteLaw('${l.mst}')">ì‚­ì œ</button>` : '<span style="color:var(--text-dim);font-size:11px;">API ë°ì´í„°</span>'}
      </td>
    </tr>`).join('');
}

function showLawForm(prefill={}) {
  document.getElementById('lawFormCard').style.display = 'block';
  document.getElementById('lawFormCard').scrollIntoView({ behavior:'smooth' });
  document.getElementById('lawFormTitle').textContent = 'âŠ• ìƒˆ ë²•ë ¹ ì¶”ê°€';
  document.getElementById('lawEditMst').value = '';
  document.getElementById('fLawName').value = prefill.name||'';
  document.getElementById('fLawDept').value = prefill.department||'';
  document.getElementById('fLawPromulg').value = prefill.promulgDate||'';
  document.getElementById('fLawEnforce').value = prefill.enforcDate||'';
  if (prefill.type) document.getElementById('fLawType').value = prefill.type;
  document.getElementById('articleBlocks').innerHTML = '';
  (prefill.articles||[{num:'',title:'',content:'',items:[]}]).forEach(a => addArticleBlock(a));
}

function hideLawForm() { document.getElementById('lawFormCard').style.display = 'none'; }

function editLaw(mst) {
  const l = allLaws.find(x => x.mst === mst);
  if (!l) return;
  showLawForm(l);
  document.getElementById('lawEditMst').value = mst;
  document.getElementById('lawFormTitle').textContent = 'âœ ë²•ë ¹ ìˆ˜ì •';
}

async function deleteLaw(mst) {
  if (!confirm('ì´ ë²•ë ¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    await apiFetch(`/api/law/local/${mst}`, { method:'DELETE' });
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); loadLaws();
  } catch(e) { toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

let artCount = 0;
function addArticleBlock(data={}) {
  const id = artCount++;
  const container = document.getElementById('articleBlocks');
  const div = document.createElement('div');
  div.className = 'article-block';
  div.id = 'art-' + id;
  div.innerHTML = `
    <div class="article-block-header">
      <span class="article-num">ì¡°ë¬¸ #${id+1}</span>
      <button class="remove-btn" onclick="document.getElementById('art-${id}').remove()">âœ• ì‚­ì œ</button>
    </div>
    <div class="form-grid col3">
      <div class="field"><label>ì¡°ë¬¸ë²ˆí˜¸</label><input class="art-num" placeholder="ì˜ˆ: 268" value="${data.num||''}"></div>
      <div class="field span2"><label>ì¡°ë¬¸ì œëª©</label><input class="art-title" placeholder="ì˜ˆ: ì—…ë¬´ìƒê³¼ì‹¤Â·ì¤‘ê³¼ì‹¤ ì¹˜ì‚¬ìƒ" value="${data.title||''}"></div>
    </div>
    <div class="field" style="margin-bottom:8px;"><label>ì¡°ë¬¸ë‚´ìš©</label><textarea class="art-content" placeholder="ì¡°ë¬¸ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">${data.content||''}</textarea></div>
    <div class="field"><label>í•­ ë‚´ìš© (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„, â‘¡ ë³¸ë¬¸ â‘¢ ë³¸ë¬¸ í˜•ì‹)</label>
      <textarea class="art-items" placeholder="â‘¡ ë‘ë²ˆì§¸ í•­ ë‚´ìš©&#10;â‘¢ ì„¸ë²ˆì§¸ í•­ ë‚´ìš©">${(data.items||[]).map(i=>i.num+' '+i.content).join('\n')}</textarea>
    </div>`;
  container.appendChild(div);
}

function getArticles() {
  return Array.from(document.getElementById('articleBlocks').querySelectorAll('.article-block')).map(block => {
    const itemsRaw = block.querySelector('.art-items').value.trim();
    const items = itemsRaw ? itemsRaw.split('\n').filter(Boolean).map(line => {
      const m = line.match(/^([â‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨â‘©])\s*(.*)/);
      return m ? { num: m[1], content: m[2] } : { num: '', content: line };
    }) : [];
    return { num: block.querySelector('.art-num').value.trim(), title: block.querySelector('.art-title').value.trim(),
      content: block.querySelector('.art-content').value.trim(), items };
  }).filter(a => a.num || a.content);
}

async function submitLaw() {
  const name = document.getElementById('fLawName').value.trim();
  if (!name) { toast('ë²•ë ¹ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'var(--red)'); return; }
  const payload = {
    name, type: document.getElementById('fLawType').value,
    department: document.getElementById('fLawDept').value.trim(),
    promulgDate: document.getElementById('fLawPromulg').value.trim(),
    enforcDate:  document.getElementById('fLawEnforce').value.trim(),
    articles: getArticles(),
  };
  const editMst = document.getElementById('lawEditMst').value;
  try {
    if (editMst) await apiFetch(`/api/law/local/${editMst}`, { method:'DELETE' });
    await apiFetch('/api/law/local', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    toast(editMst ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë²•ë ¹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    hideLawForm(); loadLaws();
  } catch(e) { toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìš©ì–´ ì‚¬ì „
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allTerms = {};

async function loadTerms() {
  try {
    allTerms = await apiFetch('/api/term');
    renderTermTable(allTerms);
    document.getElementById('termsCount').textContent = `(${Object.keys(allTerms).length}ê°œ)`;
  } catch(e) { toast('ìš©ì–´ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

function renderTermTable(terms) {
  const tbody = document.getElementById('termTableBody');
  const entries = Object.entries(terms);
  if (!entries.length) { tbody.innerHTML = '<tr><td colspan="5" class="empty">ë“±ë¡ëœ ìš©ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
  tbody.innerHTML = entries.map(([word, d]) => `
    <tr>
      <td style="font-weight:600;color:var(--accent);">${word}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-muted);">${d.hanja||'-'}</td>
      <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-muted);">${d.def||''}</td>
      <td style="font-size:11px;color:var(--blue);">${d.law||'-'}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="editTerm('${word}')">ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="deleteTerm('${word}')">ì‚­ì œ</button>
      </td>
    </tr>`).join('');
}

function filterTerms() {
  const q = document.getElementById('termSearchInput').value.toLowerCase();
  const filtered = Object.fromEntries(Object.entries(allTerms).filter(([w, d]) =>
    w.includes(q) || (d.def||'').includes(q) || (d.hanja||'').includes(q)
  ));
  renderTermTable(filtered);
}

function editTerm(word) {
  const d = allTerms[word]; if (!d) return;
  document.getElementById('fTermWord').value  = word;
  document.getElementById('fTermHanja').value = d.hanja||'';
  document.getElementById('fTermDef').value   = d.def||'';
  document.getElementById('fTermLaw').value   = d.law||'';
  document.getElementById('fTermWord').focus();
}

function clearTermForm() {
  ['fTermWord','fTermHanja','fTermDef','fTermLaw'].forEach(id => document.getElementById(id).value = '');
}

async function submitTerm() {
  const word = document.getElementById('fTermWord').value.trim();
  const def  = document.getElementById('fTermDef').value.trim();
  if (!word || !def) { toast('ìš©ì–´ì™€ ì •ì˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.', 'var(--red)'); return; }
  try {
    await apiFetch('/api/term', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ word, hanja: document.getElementById('fTermHanja').value.trim(),
        def, law: document.getElementById('fTermLaw').value.trim() }) });
    toast(`"${word}" ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    clearTermForm(); loadTerms();
  } catch(e) { toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

async function deleteTerm(word) {
  if (!confirm(`"${word}" ìš©ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  try {
    await apiFetch(`/api/term/${encodeURIComponent(word)}`, { method:'DELETE' });
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); loadTerms();
  } catch(e) { toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'var(--red)'); }
}

// ì´ˆê¸° ë¡œë“œ
window.addEventListener('DOMContentLoaded', () => {
  checkApiStatus();
  loadCases();
});
</script>
</body>
</html>
